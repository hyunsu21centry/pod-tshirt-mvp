generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PRODUCER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum JobStatus {
  RECEIVED
  IN_PRODUCTION
  PACKED
  SHIPPED
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique
  passwordHash String
  role         Role
  jobs         ProductionJob[]
  createdAt    DateTime        @default(now())
}

model Design {
  id           String      @id @default(cuid())
  name         String
  imageUrl     String
  printFileUrl String
  createdAt    DateTime    @default(now())
  orderItems   OrderItem[]
}

model ProductBase {
  id        String    @id @default(cuid())
  name      String
  basePrice Decimal   @db.Decimal(10, 2)
  variants  Variant[]
}

model Variant {
  id            String      @id @default(cuid())
  productBaseId String
  color         String
  size          String
  priceDelta    Decimal     @db.Decimal(10, 2)
  sku           String      @unique
  productBase   ProductBase @relation(fields: [productBaseId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
}

model Order {
  id              String      @id @default(cuid())
  email           String
  currency        String
  subtotal        Decimal     @db.Decimal(10, 2)
  shippingFee     Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING)
  stripeSessionId String?     @unique
  createdAt       DateTime    @default(now())
  items           OrderItem[]
}

model OrderItem {
  id             String          @id @default(cuid())
  orderId        String
  designId       String
  variantId      String
  qty            Int
  unitPrice      Decimal         @db.Decimal(10, 2)
  printPlacement String
  printWidthMm   Int
  printHeightMm  Int
  order          Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  design         Design          @relation(fields: [designId], references: [id])
  variant        Variant         @relation(fields: [variantId], references: [id])
  productionJob  ProductionJob?
}

model ProductionJob {
  id              String    @id @default(cuid())
  orderItemId     String    @unique
  producerId      String
  status          JobStatus @default(RECEIVED)
  jobTicketPdfUrl String?
  trackingCarrier String?
  trackingNumber  String?
  updatedAt       DateTime  @updatedAt
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  producer        User      @relation(fields: [producerId], references: [id])
}
